{% extends "base.html" %}
{% block content %}
<!-- INICIO DO CARRINHO -->
<main class="main_cart">
    <div class="titulo" id="titulo_cart">Seu <span>carrinho</span> </div>
    {% if request.session.carrinho %}
    <div class="content">
        <section class="sec_carrinho">
            <table class="table_cart">
                <thead class="thread_cart">
                    <tr>
                        <th>Produto</th>
                        <th>Preço</th>
                        <th>Quantidade</th>
                        <th>Total</th>
                        <th>Ação</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item_id, item in request.session.carrinho.items %}
                    <tr data-item-id="{{ item_id }}">
                        <td>
                            <div class="product">
                                {{ item.imagem|safe }}
                                <div class="info">
                                    <div class="name">{{ item.produto }}</div>
                                    <div class="category">
                                        <p>{{ item.proteinas|join:", " }}</p>
                                        <p>{{ item.acompanhamentos|join:", " }}</p>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td>
                            R$ <span id="preco_{{ item_id }}">{{ item.preco }}</span>
                        </td>
                        <td>
                            <div class="quantidade">
                                <button type="button" class="btn-decrement" onclick="updateQuantity(-1, '{{ item_id }}')">-</button>
                                <div id="quantidade_{{ item_id }}">{{ item.quantidade }}</div>
                                <button type="button" class="btn-increment" onclick="updateQuantity(1, '{{ item_id }}')">+</button>
                            </div>
                        </td>
                        <td>
                            <div class="total">R$ <span name="total_no_item" id="total_{{ item_id }}">{{ item.total }}</span></div>
                        </td>
                        <td>
                            <form method="post" action="{% url 'remover_item' %}">
                                {% csrf_token %}
                                <input type="hidden" name="item_id" value="{{ item_id }}">
                                <button type="submit" class="remove"><i class="bx bx-x" style="color: red;"></i></button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>

        <aside>
            <div class="box">
                <header>Resumo do pedido</header>
                <div class="info">
                    <h1>Total do carrinho: R$ <span  id="total_carrinho">{{ total_carrinho }}</span></h1>
                </div>

                <form method="post" action="{% url 'finalizar_pedido' %}">
                    {% csrf_token %}
                    <input type="hidden" name="total_carrinho" id="total_carrinho_hidden" value="{{ total_carrinho }}">
                    
                        <button type="submit">Finalizar Compra</button>
                    
                </form>
        </aside>
    </div>
    {% else %}
    <div class="main_vazio" style="text-align: center; font-size: larger;">
        <div class="carrinho_vazio">
            <p class="text_carrinho_vazio">
                Seu carrinho está vazio.
            </p>
        </div>
    {% endif %}
    <a href="{% url 'menu' %}">
        Voltar ao cardápio
    </a>
    </div>
</main>
<!-- FIM DO CARRINHO -->

<script>

    document.addEventListener('DOMContentLoaded', (event) => {


        updateCartTotal() // Atualiza o total geral do carrinho
    });
    function getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }

    function updateQuantity(change, itemId) {
    const quantityDiv = document.getElementById(`quantidade_${itemId}`);
    let quantity = parseInt(quantityDiv.textContent);
    const newQuantity = quantity + change;

    if (newQuantity >= 0) {
        // Atualiza a quantidade na interface
        quantityDiv.textContent = newQuantity;
        updateTotal(newQuantity, itemId);

        // Envia a nova quantidade ao servidor via fetch
        fetch('/atualizar_quantidade/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'), // Importante para segurança no Django
            },
            body: JSON.stringify({
                item_id: itemId,
                quantidade: newQuantity
            })
        })
        .then(response => {
            if (!response.ok) {
                console.log('Erro ao atualizar a quantidade no servidor');
            }
            return response.json();
        })
        .then(data => {
            console.log('Quantidade atualizada com sucesso:', data);
        })
        .catch(error => {
            console.error('Erro:', error);
        });
    }
}

// Função para obter o CSRF token do cookie
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

    function updateTotal(quantity, itemId) {
        const preco = document.getElementById(`preco_${itemId}`).textContent;
        const totalItem = document.getElementById(`total_${itemId}`);
        const newTotal = (parseFloat(preco) * quantity).toFixed(2);

        totalItem.textContent = newTotal;
        updateCartTotal()
}

    function updateCartTotal() {
        let total = 0;

        // Seleciona todos os elementos que têm o atributo name igual a 'total_no_item'
        document.querySelectorAll('[name="total_no_item"]').forEach((element) => {
            // Remove o prefixo "R$ " e substitui ',' por '.' antes de converter para float
            const itemTotal = parseFloat(element.textContent.replace('R$ ', '').replace(',', '.'));
            if (!isNaN(itemTotal)) { // Verifica se a conversão foi bem-sucedida
                total += itemTotal;
            }
        });

        // Atualiza o total do carrinho e formata para duas casas decimais
        const totalCarrinhoElement = document.getElementById('total_carrinho');
        totalCarrinhoElement.textContent = `${total.toFixed(2)}`;


        // Atualiza o valor do campo oculto no formulário
        const totalCarrinhoHidden = document.getElementById('total_carrinho_hidden');
        totalCarrinhoHidden.value = `${total.toFixed(2)}`;

        // Debug para verificar o valor total
        console.log(`Total do carrinho: R$ ${total.toFixed(2)}`);
            }
</script>
{% endblock %}
